%flowchart training
\begin{tikzpicture}[%
>=triangle 60,              % Nice arrows; your taste may be different
start chain=going below,    % General flow is top-to-bottom
node distance=6mm and 60mm, % Global setup of box spacing
every join/.style={norm},   % Default linetype for connecting boxes
]
% ---------
\tikzset{
	base/.style={draw, on chain, on grid, align=center, minimum height=4ex},
	proc/.style={base, rectangle, text width=12em},
	test/.style={base, diamond, aspect=2, text width=5em},
	term/.style={proc, rounded corners,text width = 8em},
	% coord node style is used for placing corners of connecting lines
	coord/.style={coordinate, on chain, on grid, node distance=6mm and 25mm},
	% nmark node style is used for coordinate debugging marks
	nmark/.style={ draw=none,color0, on chain, on grid, node distance=6mm and 25mm},
	% -------------------------------------------------
	% Connector line styles for different parts of the diagram
	norm/.style={->, draw},
	it/.style={font={\small\itshape}}
}
\tikzstyle{every node} = [font=\footnotesize]
	% Start by placing the nodes
	\node [proc] (mb) {Partition \(\Pi_{train}\) into \(N\) Minibatches:\\ \(\Pi_{train} = \{\Pi_{B_1},\dots,\Pi_{B_N}\}\)};
	\node [proc,join] (E0B0) {Epoch counter: \(E_h = 0\)\\Batch counter: \(B_n=0\)};
	\node [proc,join] (ini) {Initialize weights};
	\node [test,join] (t1) {\(E_h \leq E_{H}\)};
	\node [test,join] (t2) {\(B_n\leq B_{N}\)};
	\node [proc,join] (p1) {Evaluate:\\ \(AE(\Pi_{B_n})=\tilde{\Pi}_{B_n}\)};
	\node [proc,join] (p2) {Evaluate:\\ \(L(\Pi_{B_n},\tilde{\Pi}_{B_n})=E_{B_n}\)};
	\node [proc,join] (p3) {Backpropagate\\ \(E_{B_n}\)};
	\node [proc,join] (p4) {Optimize \(w\) and \(b\):\\\(Adam(w_n,b_n)=(w_{n+1},b_{n+1})\)};
	\node [proc,join] (Bplus) {\(B_{n+1} = B_n + 1\)};
	%side nodes	
	\node [proc,right =of mb] (tv) {Partition \(\Pi\) into training and validation set:\\ \(\Pi = \{\Pi_{train},\Pi_{val}\}\)};
	\node [proc, right=of t2] (p5) {Evaluate:\\ \(AE(\Pi_{val})=\tilde{\Pi}_{val}\)};
	\node [proc, right=of p1,join] (p6) {Evaluate:\\ \(L(\Pi_{val},\tilde{\Pi}_{val})=E_{val}\)};
	\node [proc, right=of p2,join] (aveMSE) {\(\frac{1}{N} \sum_n E_{B_n} =\overline{E}_B\)} ;
	\node [proc, right=of p3,join] (Eplus) {\(E_{h+1} =E_h + 1\)} ;
    \node [term,left=of t1] (fini) {finish};

    \node [coord, left=of Bplus,xshift=-2em]  (c4)  {};
    \node [coord, right=of Eplus,xshift=2em]   (c5)  {};
    %connections
    \draw [->] (tv) -- (mb);
	\draw [->] (t1.west) -- (fini); 
	\draw [->] (t2.east) -- (p5);
	\draw [->] (Eplus.east) -- (c5)|-(t1); 
	\draw [->] (Bplus.west) -- (c4)|-(t2); 
	%decisions
	\path (t1.south) to node [near start, xshift=1em] {$y$} (t2);
	\path (t1.west) to node [near start, yshift=1em] {$n$} (fini);
	\path (t2.south) to node [near start, xshift=1em] {$y$} (p1);
	\path (t2.east) to node [near start, yshift=1em] {$n$} (p5);
	%labels
	\node [nmark,right =of tv,xshift=1em]  {(a)}; 
	\node [nmark,left =of mb,xshift=-1em]  {(b)}; 
	\node [nmark,right =of ini,xshift=1em] {(c)}; 
	\node [nmark,right =of p1,xshift=1em]  {(d)};
	\node [nmark,right =of p2,xshift=1em]  {(e)};
	\node [nmark,right =of p3,xshift=1em]  {(f)};
	\node [nmark,right =of p4,xshift=1em]  {(g)};
	\node [nmark,right =of p5,xshift=1em]  {(h)};
	\node [nmark,right =of p6,xshift=1em]  {(i)};
	\node [nmark,right =of aveMSE,xshift=1em]  {(j)};
\end{tikzpicture}